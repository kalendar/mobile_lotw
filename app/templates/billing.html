{% extends "index.html" %}

{% block content %}
  <h2>Billing</h2>
  <p>Plan: <b>{{ subscription.tier }}</b></p>
  <p>Subscription Status: <b>{{ subscription.status }}</b></p>
  <p>
    Current Period End:
    <b>{{ subscription.current_period_end if subscription.current_period_end else "N/A" }}</b>
  </p>
  <p>
    Entitlement Expires:
    <b>{{ subscription.entitlement_expires_at if subscription.entitlement_expires_at else "N/A" }}</b>
  </p>

  {% if stripe_ready %}
    <div class="text-start mx-auto mb-3" style="max-width: 640px">
      <p><strong>Choose plan:</strong></p>
      {% if price_options.get("monthly") %}
        <div class="form-check">
          <input class="form-check-input" type="radio" name="billing-plan" id="billing-plan-monthly" value="monthly" checked />
          <label class="form-check-label" for="billing-plan-monthly">Monthly</label>
        </div>
      {% endif %}
      {% if price_options.get("annual") %}
        <div class="form-check">
          <input class="form-check-input" type="radio" name="billing-plan" id="billing-plan-annual" value="annual" {% if not price_options.get("monthly") %}checked{% endif %} />
          <label class="form-check-label" for="billing-plan-annual">Annual</label>
        </div>
      {% endif %}
    </div>
    <p><button id="start-checkout" class="btn btn-primary">Start Subscription</button></p>
    <script>
      document.getElementById("start-checkout")?.addEventListener("click", async () => {
        const selectedPlan = document.querySelector('input[name="billing-plan"]:checked')?.value || "monthly";
        const response = await fetch("{{ url_for('billing.create_checkout_session') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ plan: selectedPlan }),
        });
        if (!response.ok) {
          alert("Unable to start checkout right now.");
          return;
        }
        const data = await response.json();
        if (data.checkout_url) {
          window.location.href = data.checkout_url;
        }
      });
    </script>
  {% else %}
    <p>Billing is not configured yet.</p>
  {% endif %}
{% endblock %}
